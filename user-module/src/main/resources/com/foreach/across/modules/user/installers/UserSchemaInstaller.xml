<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
		xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
		xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

	<!-- Default table names -->
	<property name="table.permission" value="um_permission"/>
	<property name="table.permission_group" value="um_permission_group"/>
	<property name="table.role" value="um_role"/>
	<property name="table.role_permission" value="um_role_permission"/>
	<property name="table.user" value="um_user"/>
	<property name="table.user_role" value="um_user_role"/>

	<changeSet id="201406141719" author="arne" runAlways="true" dbms="oracle">
		<sql>
			ALTER session SET nls_length_semantics=CHAR;
		</sql>
	</changeSet>

	<changeSet id="201406141557B" author="arne">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="${table.permission_group}"/>
			</not>
		</preConditions>

		<comment>Creates permission group table</comment>

		<createTable tableName="${table.permission_group}">
			<column name="id" type="java.sql.Types.BIGINT">
				<constraints nullable="false" primaryKey="true" primaryKeyName="pk_um_perm_grp"/>
			</column>
			<column name="name" type="java.sql.Types.VARCHAR(255)"/>
			<column name="title" type="java.sql.Types.NVARCHAR(255)"/>
			<column name="description" type="java.sql.Types.NVARCHAR(2000)"/>
		</createTable>

		<createIndex tableName="${table.permission_group}" indexName="ix_um_perm_grp_name" unique="true">
			<column name="name"/>
		</createIndex>
	</changeSet>

	<changeSet id="201406141558B" author="arne">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="${table.permission}"/>
			</not>
		</preConditions>

		<comment>Creates permission table</comment>

		<createTable tableName="${table.permission}">
			<column name="id" type="java.sql.Types.BIGINT">
				<constraints nullable="false" primaryKey="true" primaryKeyName="pk_um_perm"/>
			</column>
			<column name="name" type="java.sql.Types.VARCHAR(255)"/>
			<column name="description" type="java.sql.Types.NVARCHAR(2000)"/>
			<column name="permission_group_id" type="java.sql.Types.BIGINT">
				<constraints nullable="false" referencedTableName="${table.permission_group}" referencedColumnNames="id"
				             foreignKeyName="fk_um_p_pg"/>
			</column>
		</createTable>

		<createIndex tableName="${table.permission}" indexName="ix_um_perm_name" unique="true">
			<column name="name"/>
		</createIndex>
	</changeSet>

	<changeSet id="201406141559B" author="arne">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="${table.role}"/>
			</not>
		</preConditions>

		<comment>Creates role and role_permission table</comment>

		<createTable tableName="${table.role}">
			<column name="id" type="java.sql.Types.BIGINT">
				<constraints nullable="false" primaryKey="true" primaryKeyName="pk_um_role"/>
			</column>
			<column name="name" type="java.sql.Types.VARCHAR(255)"/>
			<column name="description" type="java.sql.Types.NVARCHAR(2000)"/>
		</createTable>

		<createIndex tableName="${table.role}" indexName="ix_um_role_name" unique="true">
			<column name="name"/>
		</createIndex>

		<createTable tableName="${table.role_permission}">
			<column name="role_id" type="java.sql.Types.BIGINT">
				<constraints nullable="false" primaryKey="true" primaryKeyName="pk_um_role_perm"/>
			</column>
			<column name="permission_id" type="java.sql.Types.BIGINT">
				<constraints nullable="false" primaryKey="true" primaryKeyName="pk_um_role_perm"/>
			</column>
		</createTable>

		<addForeignKeyConstraint baseTableName="${table.role_permission}" baseColumnNames="role_id"
		                         constraintName="fk_um_rp_role_id"
		                         referencedTableName="${table.role}"
		                         referencedColumnNames="id"/>
		<addForeignKeyConstraint baseTableName="${table.role_permission}" baseColumnNames="permission_id"
		                         constraintName="fk_um_rp_permission_id"
		                         referencedTableName="${table.permission}"
		                         referencedColumnNames="id"/>
	</changeSet>

	<changeSet id="201406141600B" author="arne">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="${table.user}"/>
			</not>
		</preConditions>

		<comment>Create user table</comment>

		<createTable tableName="${table.user}">
			<column name="id" type="java.sql.Types.BIGINT">
				<constraints nullable="false" primaryKey="true" primaryKeyName="pk_um_user"/>
			</column>
			<column name="username" type="java.sql.Types.VARCHAR(255)"/>
			<column name="email" type="java.sql.Types.VARCHAR(255)"/>
			<column name="password" type="java.sql.Types.NVARCHAR(255)"/>
		</createTable>

		<addNotNullConstraint tableName="${table.user}" columnName="username"
		                      columnDataType="java.sql.Types.VARCHAR(255)"/>

		<createIndex tableName="${table.user}" indexName="ix_um_user_username" unique="true">
			<column name="username"/>
		</createIndex>
	</changeSet>

	<changeSet id="201406141517B" author="arne">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="${table.user_role}"/>
			</not>
		</preConditions>

		<comment>Create user role table</comment>

		<createTable tableName="${table.user_role}">
			<column name="user_id" type="java.sql.Types.BIGINT">
				<constraints nullable="false" primaryKey="true" primaryKeyName="pk_um_user_role"/>
			</column>
			<column name="role_id" type="java.sql.Types.BIGINT">
				<constraints nullable="false" primaryKey="true" primaryKeyName="pk_um_user_role"/>
			</column>
		</createTable>

		<addForeignKeyConstraint baseTableName="${table.user_role}" baseColumnNames="user_id"
		                         constraintName="fk_um_ur_user_id"
		                         referencedTableName="${table.user}"
		                         referencedColumnNames="id"/>
		<addForeignKeyConstraint baseTableName="${table.user_role}" baseColumnNames="role_id"
		                         constraintName="fk_um_ur_role_id"
		                         referencedTableName="${table.role}"
		                         referencedColumnNames="id"/>
	</changeSet>

    <changeSet id="201407071223" author="marc">
        <comment>Add some core columns to the user table</comment>
        <addColumn tableName="${table.user}">
            <column name="firstname" type="java.sql.Types.VARCHAR(255)"/>
            <column name="lastname" type="java.sql.Types.VARCHAR(255)"/>
            <column name="name" type="java.sql.Types.VARCHAR(255)"/>
            <column name="emailConfirmed" type="java.sql.Types.BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="deleted" type="java.sql.Types.BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="java.sql.Types.BIGINT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="201407071620" author="marc">
        <comment>Make sure that any existing admin users get the default values for the new columns in changeset 201407071223</comment>
        <update tableName="${table.user}">
            <column name="emailConfirmed" type="java.sql.Types.BOOLEAN" valueBoolean="true" />
            <column name="deleted" type="java.sql.Types.BOOLEAN" valueBoolean="false" />
            <column name="status" type="java.sql.Types.BIGINT" valueNumeric="15" />
            <where>username='admin'</where>
        </update>
    </changeSet>

    <changeSet id="201407090958" author="marc">
        <comment>Rename name column to displayname column</comment>
        <renameColumn columnDataType="java.sql.Types.VARCHAR(255)"
                      newColumnName="displayname"
                      oldColumnName="name"
                      tableName="${table.user}"/>
    </changeSet>
	
	<changeSet id="201407140926" author="arne">
		<comment>Make the name columns unicode</comment>
		<modifyDataType tableName="${table.user}" columnName="firstname" newDataType="java.sql.Types.NVARCHAR(255)" />
		<modifyDataType tableName="${table.user}" columnName="lastname" newDataType="java.sql.Types.NVARCHAR(255)" />
		<modifyDataType tableName="${table.user}" columnName="displayname" newDataType="java.sql.Types.NVARCHAR(255)" />
	</changeSet>

	<changeSet id="201407141556" author="marc">
		<comment>Rename status column to restrictions column</comment>
		<renameColumn columnDataType="java.sql.Types.BIGINT"
		              newColumnName="restrictions"
		              oldColumnName="status"
		              tableName="${table.user}"/>
	</changeSet>

	<changeSet id="201407141557" author="marc">
		<comment>Rename status column to restrictions column</comment>
		<update tableName="${table.user}">
			<column name="restrictions" type="java.sql.Types.BIGINT" valueNumeric="0" />
		</update>
	</changeSet>

	<changeSet id="201407151203" author="marc">
		<comment>Rename camelcased fields</comment>
		<renameColumn columnDataType="java.sql.Types.NVARCHAR(255)"
		              newColumnName="display_name"
		              oldColumnName="displayname"
		              tableName="${table.user}"/>
		<renameColumn columnDataType="java.sql.Types.NVARCHAR(255)"
		              newColumnName="last_name"
		              oldColumnName="lastname"
		              tableName="${table.user}"/>
		<renameColumn columnDataType="java.sql.Types.NVARCHAR(255)"
		              newColumnName="first_name"
		              oldColumnName="firstname"
		              tableName="${table.user}"/>
		<renameColumn columnDataType="java.sql.Types.BOOLEAN"
		              newColumnName="email_confirmed"
		              oldColumnName="emailConfirmed"
		              tableName="${table.user}"/>
	</changeSet>

	<changeSet id="201407151402" author="marc">
		<dropNotNullConstraint tableName="${table.user}" columnName="email_confirmed"
		                      columnDataType="java.sql.Types.BOOLEAN"/>
		<dropNotNullConstraint tableName="${table.user}" columnName="restrictions"
		                      columnDataType="java.sql.Types.BIGINT"/>
		<addNotNullConstraint tableName="${table.user}" columnName="email_confirmed"
		                      columnDataType="java.sql.Types.BOOLEAN"/>
		<addNotNullConstraint tableName="${table.user}" columnName="restrictions"
		                      columnDataType="java.sql.Types.BIGINT"/>
	</changeSet>

</databaseChangeLog>